<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - QR Codes | Virtual Projection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Space Grotesk', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-6 py-12">
        <h1 class="text-4xl font-bold mb-8 text-center">
            Administração - QR Codes
        </h1>
        
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-2">Total de Inscritos</h3>
                <p class="text-3xl font-bold text-blue-400" id="totalAttendees">0</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-2">QR Codes Gerados</h3>
                <p class="text-3xl font-bold text-green-400" id="qrGenerated">0</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-2">Check-ins Realizados</h3>
                <p class="text-3xl font-bold text-purple-400" id="checkedInCount">0</p>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-semibold mb-4">Ações</h3>
            <div class="flex flex-wrap gap-4">
                <button id="refreshData" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg">
                    Atualizar Dados
                </button>
                <button id="sendEmails" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg">
                    Aprovar & Enviar todos pendentes
                </button>
                <button id="downloadList" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg">
                    Download Lista
                </button>
            </div>
        </div>
        
        <!-- Attendees List -->
        <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Lista de Participantes</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="py-3 px-4">ID</th>
                            <th class="py-3 px-4">Nome</th>
                            <th class="py-3 px-4">E-mail</th>
                            <th class="py-3 px-4">Empresa</th>
                            <th class="py-3 px-4">Telefone</th>
                            <th class="py-3 px-4">Cargo</th>
                            <th class="py-3 px-4">Data/Hora</th>
                            <th class="py-3 px-4">QR Code</th>
                            <th class="py-3 px-4">E-mail Enviado</th>
                            <th class="py-3 px-4">Status</th>
                            <th class="py-3 px-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="attendeesList">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let attendeesData = [];

        // Load attendees data
        function loadAttendeesData() {
            console.log('Loading attendees data...');
            fetch('/attendees')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    if (data.success) {
                        attendeesData = data.attendees;
                        console.log('Attendees loaded:', attendeesData.length);
                        updateStats();
                        updateAttendeesList();
                    } else {
                        console.error('Error loading data:', data.error);
                        document.getElementById('attendeesList').innerHTML = 
                            '<tr><td colspan="11" class="text-center py-4 text-gray-400">Erro ao carregar dados: ' + (data.error || 'Erro desconhecido') + '</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    document.getElementById('attendeesList').innerHTML = 
                        '<tr><td colspan="11" class="text-center py-4 text-gray-400">Erro de conexão: ' + error.message + '</td></tr>';
                });
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalAttendees').textContent = attendeesData.length;
            document.getElementById('qrGenerated').textContent = attendeesData.filter(a => a.qr_code_url).length;
            document.getElementById('checkedInCount').textContent = attendeesData.filter(a => a.checked_in).length;
        }

        // Update attendees list
        function updateAttendeesList() {
            const tbody = document.getElementById('attendeesList');
            tbody.innerHTML = '';

            attendeesData.forEach(guest => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-700';
                row.innerHTML = `
                    <td class="py-3 px-4 font-mono text-sm">${guest.id}</td>
                    <td class="py-3 px-4">${guest.name || ''}</td>
                    <td class="py-3 px-4">${guest.email || ''}</td>
                    <td class="py-3 px-4">${guest.company || ''}</td>
                    <td class="py-3 px-4">${guest.phone || ''}</td>
                    <td class="py-3 px-4">${guest.position || ''}</td>
                    <td class="py-3 px-4 text-sm">${guest.created_at ? new Date(guest.created_at).toLocaleString('pt-BR') : ''}</td>
                    <td class="py-3 px-4">
                        ${guest.qr_code_url ?
                            `<a href="${guest.qr_code_url}" target="_blank" class="text-blue-400 hover:underline">Ver QR</a>` :
                            '<span class="text-red-400">N/A</span>'
                        }
                    </td>
                    <td class="py-3 px-4">
                        ${guest.confirmation_sent ?
                            '<span class="text-green-400">✓ Enviado</span>' :
                            '<span class="text-yellow-400">⏳ Pendente</span>'
                        }
                    </td>
                    <td class="py-3 px-4">
                        ${guest.checked_in ?
                            '<span class="text-green-400">✓ Confirmado</span>' :
                            '<span class="text-gray-400">Pendente</span>'
                        }
                    </td>
                    <td class="py-3 px-4">
                        ${guest.confirmation_sent ?
                            '<span class="text-gray-400">—</span>' :
                            `<button class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded" onclick="approveAndSend('${guest.id}')">Aprovar & Enviar</button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Approve & send a single attendee
        async function approveAndSend(id) {
            try {
                const res = await fetch('/approve-and-send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                const out = await res.json();
                if (out.success) {
                    alert('Aprovado e enviado com sucesso!');
                    loadAttendeesData();
                } else {
                    alert('Falha ao aprovar/enviar: ' + (out.error || 'Erro'));
                }
            } catch (e) {
                console.error(e);
                alert('Erro de conexão');
            }
        }

        // Bulk: approve and send to all pending
        async function sendEmails() {
            const button = document.getElementById('sendEmails');
            button.disabled = true;
            button.textContent = 'Enviando...';
            const pendentes = attendeesData.filter(a => !a.confirmation_sent);
            let ok = 0, fail = 0;
            for (const a of pendentes) {
                try {
                    const res = await fetch('/approve-and-send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: a.id })
                    });
                    const out = await res.json();
                    if (out.success) ok++; else fail++;
                } catch {
                    fail++;
                }
            }
            alert(`Concluído. Sucesso: ${ok}, Falhas: ${fail}`);
            loadAttendeesData();
            button.disabled = false;
            button.textContent = 'Aprovar & Enviar todos pendentes';
        }

        // Download attendees list as CSV
        function downloadList() {
            const csv = ['ID,Nome,E-mail,Data/Hora,QR Code,E-mail Enviado'];
            attendeesData.forEach(attendee => {
                csv.push([
                    attendee.id,
                    attendee.name,
                    attendee.email,
                    attendee.created_at,
                    attendee.qr_code_url || '',
                    attendee.confirmation_sent ? 'Sim' : 'Não'
                ].join(','));
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'participantes-virtual-projection.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('refreshData').addEventListener('click', loadAttendeesData);
        document.getElementById('sendEmails').addEventListener('click', sendEmails);
        document.getElementById('downloadList').addEventListener('click', downloadList);

        // Initial load
        loadAttendeesData();
        
        // Auto refresh every 30 seconds
        setInterval(loadAttendeesData, 30000);
    </script>
</body>
</html>