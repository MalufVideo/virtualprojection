<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - QR Codes | Virtual Projection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Space Grotesk', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-6 py-12">
        <h1 class="text-4xl font-bold mb-8 text-center">
            Administração - QR Codes
        </h1>
        
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-2">Total de Inscritos</h3>
                <p class="text-3xl font-bold text-blue-400" id="totalAttendees">0</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-2">QR Codes Gerados</h3>
                <p class="text-3xl font-bold text-green-400" id="qrGenerated">0</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-2">E-mails Enviados</h3>
                <p class="text-3xl font-bold text-purple-400" id="emailsSent">0</p>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="bg-gray-800 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-semibold mb-4">Ações</h3>
            <div class="flex flex-wrap gap-4">
                <button id="refreshData" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg">
                    Atualizar Dados
                </button>
                <button id="sendEmails" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg">
                    Enviar E-mails com QR
                </button>
                <button id="downloadList" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg">
                    Download Lista
                </button>
            </div>
        </div>
        
        <!-- Attendees List -->
        <div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-semibold mb-4">Lista de Participantes</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="py-3 px-4">ID</th>
                            <th class="py-3 px-4">Nome</th>
                            <th class="py-3 px-4">E-mail</th>
                            <th class="py-3 px-4">Data/Hora</th>
                            <th class="py-3 px-4">QR Code</th>
                            <th class="py-3 px-4">E-mail Enviado</th>
                        </tr>
                    </thead>
                    <tbody id="attendeesList">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let attendeesData = [];

        // Load attendees data
        function loadAttendeesData() {
            fetch('qr/attendees.json')
                .then(response => response.json())
                .then(data => {
                    attendeesData = data;
                    updateStats();
                    updateAttendeesList();
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    document.getElementById('attendeesList').innerHTML = 
                        '<tr><td colspan="6" class="text-center py-4 text-gray-400">Nenhum dado encontrado</td></tr>';
                });
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalAttendees').textContent = attendeesData.length;
            document.getElementById('qrGenerated').textContent = attendeesData.filter(a => a.qr_file).length;
            document.getElementById('emailsSent').textContent = attendeesData.filter(a => a.email_sent).length;
        }

        // Update attendees list
        function updateAttendeesList() {
            const tbody = document.getElementById('attendeesList');
            tbody.innerHTML = '';

            attendeesData.forEach(attendee => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-700';
                row.innerHTML = `
                    <td class="py-3 px-4 font-mono text-sm">${attendee.id}</td>
                    <td class="py-3 px-4">${attendee.name}</td>
                    <td class="py-3 px-4">${attendee.email}</td>
                    <td class="py-3 px-4 text-sm">${new Date(attendee.timestamp).toLocaleString('pt-BR')}</td>
                    <td class="py-3 px-4">
                        ${attendee.qr_file ? 
                            `<a href="qr/${attendee.qr_file}" target="_blank" class="text-blue-400 hover:underline">Ver QR</a>` : 
                            '<span class="text-red-400">N/A</span>'
                        }
                    </td>
                    <td class="py-3 px-4">
                        ${attendee.email_sent ? 
                            '<span class="text-green-400">✓ Enviado</span>' : 
                            '<span class="text-yellow-400">⏳ Pendente</span>'
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Send emails
        function sendEmails() {
            const button = document.getElementById('sendEmails');
            button.disabled = true;
            button.textContent = 'Enviando...';

            fetch('send-qr-email.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'send_email=1'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${data.emails_sent} e-mails enviados com sucesso!`);
                    loadAttendeesData(); // Refresh data
                } else {
                    alert('Erro ao enviar e-mails: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao enviar e-mails');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Enviar E-mails com QR';
            });
        }

        // Download attendees list as CSV
        function downloadList() {
            const csv = ['ID,Nome,E-mail,Data/Hora,QR Code,E-mail Enviado'];
            attendeesData.forEach(attendee => {
                csv.push([
                    attendee.id,
                    attendee.name,
                    attendee.email,
                    attendee.timestamp,
                    attendee.qr_file || '',
                    attendee.email_sent ? 'Sim' : 'Não'
                ].join(','));
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'participantes-virtual-projection.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('refreshData').addEventListener('click', loadAttendeesData);
        document.getElementById('sendEmails').addEventListener('click', sendEmails);
        document.getElementById('downloadList').addEventListener('click', downloadList);

        // Initial load
        loadAttendeesData();
        
        // Auto refresh every 30 seconds
        setInterval(loadAttendeesData, 30000);
    </script>
</body>
</html>